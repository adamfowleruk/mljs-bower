
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.searchhelper={};com.marklogic.widgets.searchhelper.processValueAll=function(str){return com.marklogic.widgets.searchhelper.processValue(str,"all");};com.marklogic.widgets.searchhelper.processValue=function(str,mode){var name=str;name=com.marklogic.widgets.searchhelper.splitdash(name,mode);name=com.marklogic.widgets.searchhelper.splitunderscore(name,mode);name=com.marklogic.widgets.searchhelper.camelcase(name,mode);return name;};com.marklogic.widgets.searchhelper.snippet=function(result){var resStr="";for(var i=0;i<result.matches.length;i++){resStr+="<div class='searchresults-snippet'>\"";for(var m=0;m<result.matches[i]["match-text"].length;m++){if("string"==typeof result.matches[i]["match-text"][m]){resStr+=result.matches[i]["match-text"][m];}else{resStr+="<span class='searchresults-snippet-highlight'>"+result.matches[i]["match-text"][m].highlight+"</span>";}}
resStr+="\"</div>";}
return resStr;};com.marklogic.widgets.searchhelper.splitdash=function(value,mode){if(value==undefined||value==null){mljs.defaultconnection.logger.warn("WARNING: splitdash(): value is "+value);return"";}
if("string"!=typeof value){mljs.defaultconnection.logger.warn("WARNING: splitdash(): value is not of type string, but of type '"+(typeof value)+"'");return""+value;}
var name=value;if("all"==mode||"splitdash"==mode){var parts=name.split("-");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i]+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.splitunderscore=function(value,mode){var name=value;if("all"==mode||"splitunderscore"==mode){var parts=name.split("_");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i]+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.camelcase=function(value,mode){var name=value;if("all"==mode||"camelcase"==mode){var parts=name.split(" ");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i].substring(0,1).toUpperCase()+parts[i].substring(1)+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.jsontohtml=function(json){var str="<div class='jsonhtml'>";for(var tag in json){if("object"==typeof json[tag]){str+="<div class='jsonproperty'><div class='jsonpropertytitlewrapper'><span class='jsonpropertytitle'>"+com.marklogic.widgets.searchhelper.camelcase(tag)+":- </span></div>";str+=com.marklogic.widgets.searchhelper.jsontohtml(json[tag]);str+="</div>";}else{str+="<div class='jsonproperty'><div class='jsonpropertytitlewrapper'>";str+="<span class='jsonpropertytitle'>"+com.marklogic.widgets.searchhelper.camelcase(tag)+": </span>";str+="<span class='jsonpropertyvalue'>"+json[tag]+"</span>";str+="</div></div>";}}
str+="</div>";return str;};com.marklogic.widgets.searchhelper.xmltohtml=function(xml){return"";};com.marklogic.widgets.searchhelper.handleJson=function(result,json){var resStr="";var title=result.uri;if(undefined!=json&&undefined!=json.title){title=json.title;}
var snippet=null;if(undefined!=json&&undefined!=json.summary){snippet=json.summary;}else if(undefined!=json){snippet=com.marklogic.widgets.searchhelper.jsontohtml(json);}else{}
if(null==snippet){mljs.defaultconnection.logger.debug("defaultProcessor: No JSON summary, building JSON tree HTML output");}
resStr+="<div class='searchresults-result'><div class='h4'>"+result.index+". "+title+"</div>";if(null!=snippet){resStr+="<div class='searchresults-snippet'>"+snippet+"</div>";}
resStr+="</div>";return resStr;};com.marklogic.widgets.advancedsearch=function(container){this.container=container;this.ctx=new mljs.prototype.searchcontext();this._include=null;this._init();};com.marklogic.widgets.advancedsearch.getConfigurationDefinition=function(){return{}};com.marklogic.widgets.advancedsearch.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}};com.marklogic.widgets.advancedsearch.prototype.include=function(arr){this._include=arr;};com.marklogic.widgets.advancedsearch.prototype._init=function(){var s="<div class='mljswidget advancedsearch'>";s+=" <h2>Advanced Search</h2>";s+=" <div class='' id='"+this.container+"-fields'></div>";s+=" <div style='text-align:center;width:100%;'>";s+="  <input class='btn btn-primary advancedsearch-submit' type='submit' id='"+this.container+"-submit' value='Search' />";s+=" </div>";s+="</div>";document.getElementById(this.container).innerHTML=s;var self=this;document.getElementById(this.container+"-submit").onclick=function(){self._dosearch();};};com.marklogic.widgets.advancedsearch.prototype._dosearch=function(){var facets=[];for(var i=0,max=this._used.length,idx;i<max;i++){idx=this._used[i];var val=document.getElementById(this.container+"-field-"+idx).value;if(val.trim().length>0){facets.push({name:this._options.options.constraint[idx].name,value:val});}}
this.ctx.contributeFacets(facets);};com.marklogic.widgets.advancedsearch.prototype.setSearchContext=function(context){this.ctx=context;};com.marklogic.widgets.advancedsearch.prototype.getSearchContext=function(){return this.ctx;};com.marklogic.widgets.advancedsearch.prototype.render=function(){this._options=this.ctx.getOptions();var s="";this._used=[];for(var i=0,max=this._options.options.constraint.length,con;i<max;i++){con=this._options.options.constraint[i];if(null==this._include||this._include.contains(con.name)){if(undefined!=con.range){if("xs:string"==con.range.type){s+="<span class=' advancedsearch-field'>";var title=""
if(undefined!=con.annotation&&con.annotation.length>0){title=con.annotation[0];}else{title=com.marklogic.widgets.searchhelper.processValue(con.name,"all");}
s+=" <label for='"+this.container+"-field-"+i+"'>"+title+": </label>";s+=" <input id='"+this.container+"-field-"+i+"' type='text' />";s+="</span>";this._used.push(i);if(0==this._used.length%2){s+="<br />";}}}}}
document.getElementById(this.container+"-fields").innerHTML=s;var self=this;var searchKeyPress=function(e)
{if(typeof e=='undefined'&&window.event){e=window.event;}
if(e.keyCode==13)
{document.getElementById(self.container+"-submit").click();}else{}};for(var i=0,max=this._used.length,idx;i<max;i++){idx=this._used[i];var input=document.getElementById(this.container+"-field-"+idx);input.onkeypress=searchKeyPress;}};com.marklogic.widgets.searchbar=function(container){if(undefined==com.marklogic.widgets.searchbar.list){com.marklogic.widgets.searchbar.list=new Array();}
this.container=container;this.ctx=new mljs.prototype.searchcontext();this._mode="fullquery";mljs.defaultconnection.logger.debug("adding search bar html");document.getElementById(container).innerHTML="<div class='mljswidget well searchbar-inner'>"+"<div class='input-append input-prepend searchbar-queryrow'>"+"<span class='searchbar-label' for='"+container+"-searchinput'>Search: </span>"+"<input class='span2 searchbar-query' type='text' id='"+container+"-searchinput' value='' placeholder='Enter query' />"+"<button class='btn btn-primary searchbar-submit' type='button' id='"+container+"-submit'>Search</button>"+"</div>"+"<ul class='list-unstyled searchbar-autocomplete hidden' id='"+container+"-ac' tabindex='0'></ul>"+"<div class='searchbar-errorrow hidden'></div>";"</div>";mljs.defaultconnection.logger.debug("adding submit click handler");var self=this;document.getElementById(container+"-submit").onclick=function(){self._dosearch(self);};mljs.defaultconnection.logger.debug("added submit click handler");var input=document.getElementById(container+"-searchinput");var searchKeyPress=function(e)
{if(typeof e=='undefined'&&window.event){e=window.event;}
if(e.keyCode==13)
{self.updateSuggestions(null);document.getElementById(container+"-submit").click();}else{self.ctx.doSuggest(input.value);}};input.onkeypress=searchKeyPress;};com.marklogic.widgets.searchbar.getConfigurationDefinition=function(){return{}};com.marklogic.widgets.searchbar.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}};com.marklogic.widgets.searchbar.__dosearch=function(submitelement){var id=submitelement.getAttribute("id");id=id.substring(0,id.length-12);var bar=com.marklogic.widgets.searchbar.list[id];if(null==id){mljs.defaultconnection.logger.debug("searchbar.__dosearch - search bar instance does not exist: "+id);}else{bar._dosearch();}};com.marklogic.widgets.searchbar.prototype.clear=function(){document.getElementById(this.container+"-searchinput").value="";this.ctx.reset();};com.marklogic.widgets.searchbar.prototype.updateSuggestions=function(suggestions){var ul=document.getElementById(this.container+"-ac");if(undefined==suggestions||suggestions.suggestions.length==0){com.marklogic.widgets.hide(ul,true);}else{var cont=document.getElementById(this.container);var input=document.getElementById(this.container+"-searchinput");var s="";for(var i=0,max=suggestions.suggestions.length,sug;i<max;i++){sug=suggestions.suggestions[i];s+="<li class='search-suggest-item'><a id='"+this.container+"-s-"+i+"'>"+sug+"</a></li>";}
ul.innerHTML=s;function setCursor(node,pos){var node=(typeof node=="string"||node instanceof String)?document.getElementById(node):node;if(!node){return false;}else if(node.createTextRange){var textRange=node.createTextRange();textRange.collapse(true);textRange.moveEnd(pos);textRange.moveStart(pos);textRange.select();return true;}else if(node.setSelectionRange){node.setSelectionRange(pos,pos);return true;}
return false;};var handler=function(suggestion){com.marklogic.widgets.hide(ul,true);var q=input.value;var pos=q.length-1;var found=false;while(!found&&pos>0){var ch=q.substring(pos,pos+1);if(":"==ch||" "==ch){found=true;pos++;}else{pos--;}}
input.value=q.substring(0,pos)+suggestion;setCursor(input,q.length);};var addSelectHandler=function(el,suggestion){el.onclick=function(e){handler(suggestion);};var selectKeyPress=function(e){if(typeof e=='undefined'&&window.event){e=window.event;}
if(e.keyCode==13){handler(suggestion);}};el.onkeypress=selectKeyPress;};for(var i=0,max=suggestions.suggestions.length,sug;i<max;i++){sug=suggestions.suggestions[i];var li=document.getElementById(this.container+"-s-"+i);addSelectHandler(li,sug)}
ul.style.left=input.left-cont.left;com.marklogic.widgets.hide(ul,false);}};com.marklogic.widgets.searchbar.prototype.execute=function(){var q=document.getElementById(this.container+"-searchinput").value;this.ctx.dosimplequery(q);};com.marklogic.widgets.searchbar.prototype.setMode=function(mode){this._mode=mode;};com.marklogic.widgets.searchbar.prototype.setModeContributeStructured=function(){this._mode="contributestructured";};com.marklogic.widgets.searchbar.prototype._dosearch=function(self){var q=document.getElementById(self.container+"-searchinput").value;if(this._mode=="fullquery"){self.ctx.dosimplequery(q);}else if(this._mode=="contributestructured"){self.ctx.contributeStructuredQuery(this.container,q);}};com.marklogic.widgets.searchbar.prototype.updateSimpleQuery=function(q){if(null!=q&&undefined!=q&&""!=q){mljs.defaultconnection.logger.debug(" - updateSimpleQuery: Setting query string to: "+q);document.getElementById(this.container+"-searchinput").value=q;}};com.marklogic.widgets.searchbar.prototype.updateResults=function(results){if(typeof(results)!="boolean"&&undefined!=results&&null!=results&&undefined!=results.qtext){mljs.defaultconnection.logger.debug(" - updateResults: Setting query string to: "+results.qtext);document.getElementById(this.container+"-searchinput").value=results.qtext;}};com.marklogic.widgets.searchbar.prototype.setSearchContext=function(context){this.ctx=context;};com.marklogic.widgets.searchbar.prototype.getSearchContext=function(){return this.ctx;};com.marklogic.widgets.searchfacets=function(container){this.container=container;this.listSize=5;this.extendedSize=10;this.allowShowAll=true;this.hideEmptyFacets=true;this.facetSettings=new Array();this.results=null;this.ctx=mljs.defaultconnection.createSearchContext();this.selected=new Array();this.facetNameTransform="all";this.facetValueTransform="all";this.selectionPublisher=new com.marklogic.events.Publisher();this._refresh();};com.marklogic.widgets.searchfacets.getConfigurationDefinition=function(){return{listSize:{type:"positiveInteger",minimum:1,default:5,title:"List Size",description:"How many facet values to show at first."},extendedSize:{type:"positiveInteger",minimum:1,default:10,title:"Extended List Size",description:"How many values to show when a user clicks 'Show More'."},allowShowAll:{type:"boolean",default:true,title:"Display Show All action",description:"Whether the Show All link should be allowed if there are more facet values than the value of Extended Size."},hideEmptyFacets:{type:"boolean",default:true,title:"Hide Empty Facets",description:"Should facets with no values be hidden?"}}};com.marklogic.widgets.searchfacets.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.searchfacets.prototype.setSearchContext=function(context){this.ctx=context;};com.marklogic.widgets.searchfacets.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchfacets.prototype._setFacetSettings=function(facetName,extended,showall){var json={extended:extended,showAll:showall};this.facetSettings[facetName]=json;};com.marklogic.widgets.searchfacets.prototype._getFacetSettings=function(facetName){var res=this.facetSettings[facetName];if(undefined==res||null==res){return{extended:false,showAll:false};}else{return res;}};com.marklogic.widgets.searchfacets.prototype.clear=function(){this.results=null;this._refresh();};com.marklogic.widgets.searchfacets.prototype._refresh=function(){if(false==this.results||true==this.results){return;}
var more=new Array();var extended=new Array();var str="<div class='mljswidget well searchfacets'>"+"<div class='title h3 searchfacets-title'>Browse</div>"+"<div id='"+this.container+"-facetinfo' class='search-facets'> ";var self=this;var fname=function(name){var opts=self.ctx.getOptions();var annotation=opts._findConstraint(name).annotation;if(undefined==annotation){return self._transformFacetName(name);}else{return annotation[0];}};var deselectionTodo=new Array();if(0!=this.selected.length){str+="<div class='panel panel-info searchfacets-selected'>";for(var i=0;i<this.selected.length;i++){var s=this.selected[i];str+="<div class='searchfacets-selection'>"+"<a href='#"+this.container+"-desel-"+s.name+"-"+s.value+"' class='searchfacets-deselect' id='"+this.container+"-desel-"+s.name+"-"+s.value+"'><span class='glyphicon glyphicon-remove'></span></a> "+
fname(s.name)+": "+this._transformFacetValue(s.name,s.value)+"</div>";deselectionTodo.push(s);}
str+="</div>";}
var facetHandlersTodo=new Array();if(null!=this.results&&undefined!=this.results){if(undefined!=this.results.facets){for(var name in this.results.facets){var facet=this.results.facets[name];var facetStr="<div class='panel panel-info searchfacets-facet' id='"+this.container+"-facetinfo-"+name+"'><div class='panel-heading searchfacets-facet-title'>"+fname(name)+"</div>"+"<div class='panel-body searchfacets-facet-values'>";var settings=this._getFacetSettings(name);var max=this.listSize;var values=facet.facetValues;bubbleSort(values,"count");var valuesCount=values.length;if(settings.extended){max=this.extendedSize;}
if(settings.showAll&&settings.extended){max=valuesCount;}
for(var v=0;v<max&&v<valuesCount;v++){if(v<this.listSize||(v<this.extendedSize&&settings.extended)||settings.showAll){var fv=values[v];facetStr+="<div class='";if(1==(v%2)){facetStr+="bg-gray-lighter ";}
facetStr+="searchfacets-facet-value' id='"+this.container+"-fv-"+name+"-"+fv.name+"'>"+this._transformFacetValue(name,fv.name)+" <span class='badge searchfacets-facet-count'>"+fv.count+"</span>"+"</div>";facetHandlersTodo.push({name:name,value:fv.name});}}
if(valuesCount>this.listSize){if(!settings.showAll){facetStr+="<div class='text-info searchfacets-more'><a href='#"+this.container+"-facetinfo-"+name+"' id='"+this.container+"-"+name+"-more-link'>";if(!settings.extended){facetStr+="More";}else{facetStr+="Less";}
facetStr+="...</a></div>";more.push(name);}
if(settings.extended){if(valuesCount>this.extendedSize&&this.allowShowAll){facetStr+="<div class='text-info searchfacets-extended'><a href='#"+this.container+"-facetinfo-"+name+"' id='"+this.container+"-"+name+"-extended-link'>";if(settings.showAll){facetStr+="Less"}else{facetStr+="All";}
facetStr+="...</a></div>";extended.push(name);}}}
facetStr+="</div></div>";if(!(0==valuesCount&&this.hideEmptyFacets)){str+=facetStr;}}}}
str+="</div></div>";document.getElementById(this.container).innerHTML=str;var self=this;var addfh=function(fh){var el=document.getElementById(self.container+"-fv-"+fh.name+"-"+fh.value);if(undefined!=el){el.onclick=function(){self._selectFacet(fh.name,fh.value)};}};for(var i=0;i<facetHandlersTodo.length;i++){var fh=facetHandlersTodo[i];addfh(fh);}
var remfh=function(fh){var el=document.getElementById(self.container+"-desel-"+fh.name+"-"+fh.value);if(undefined!=el){el.onclick=function(){self._deselectFacet(fh.name,fh.value)};}};for(var i=0;i<deselectionTodo.length;i++){var fh=deselectionTodo[i];remfh(fh);}
var addmoreh=function(morei){document.getElementById(self.container+"-"+morei+"-more-link").onclick=function(){self._more(morei);};};for(var i=0;i<more.length;i++){var morei=more[i];mljs.defaultconnection.logger.debug("more[i]: "+morei+" , i: "+i);addmoreh(morei);}
var addexth=function(exti){document.getElementById(self.container+"-"+exti+"-extended-link").onclick=function(){self._extended(exti);};};for(var i=0;i<extended.length;i++){var exti=extended[i];mljs.defaultconnection.logger.debug("extended[i]: "+exti+" , i: "+i);addexth(exti);}};com.marklogic.widgets.searchfacets.prototype._selectFacet=function(facetName,value){mljs.defaultconnection.logger.debug("Selecting "+facetName+":"+value);this.selected.push({name:facetName,value:value});this._refresh();this.selectionPublisher.publish(this.selected);};com.marklogic.widgets.searchfacets.prototype._deselectFacet=function(facetName,value){mljs.defaultconnection.logger.debug("Deselecting "+facetName+":"+value);var newsel=new Array();for(var i=0;i<this.selected.length;i++){var el=this.selected[i];if(el.name==facetName&&el.value==value){}else{newsel.push(el);}}
this.selected=newsel;this._refresh();this.selectionPublisher.publish(this.selected);};com.marklogic.widgets.searchfacets.prototype._transformFacetName=function(facetName){return com.marklogic.widgets.searchhelper.processValue(facetName,this.facetNameTransform);};com.marklogic.widgets.searchfacets.prototype._transformFacetValue=function(facetName,facetValue){var fv=this.ctx.getOptionsBuilder().getFacetValueString(facetName,facetValue);if(null==fv){return com.marklogic.widgets.searchhelper.processValue(facetValue,this.facetValueTransform);}else{return fv;}};com.marklogic.widgets.searchfacets.prototype._more=function(facetName){mljs.defaultconnection.logger.debug("searchfacets._more: "+facetName+", extended currently: "+this._getFacetSettings(facetName).extended);this._setFacetSettings(facetName,!this._getFacetSettings(facetName).extended,false);this._refresh();};com.marklogic.widgets.searchfacets.prototype._extended=function(facetName){mljs.defaultconnection.logger.debug("searchfacets._extended: "+facetName+", showAll currently: "+this._getFacetSettings(facetName).showAll);this._setFacetSettings(facetName,true,!this._getFacetSettings(facetName).showAll);this._refresh();};com.marklogic.widgets.searchfacets.prototype.setSizes=function(listSize,extendedSize){this.listSize=listSize;this.extendedSize=extendedSize;};com.marklogic.widgets.searchfacets.prototype.setAllowShowAll=function(boolvalue){this.allowShowAll=boolvalue;};com.marklogic.widgets.searchfacets.prototype.addFacetSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchfacets.prototype.removeFacetSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchfacets.prototype.updateFacets=function(results){if("boolean"==typeof results){return;}
this.results=results;this.selected=this.ctx.lastParsed.facets;this._refresh();};com.marklogic.widgets.searchfacets.prototype.updateSelectedFacets=function(facets){mljs.defaultconnection.logger.debug("In updateSelectedFacets(facets): "+JSON.stringify(facets));this.selected=facets;this._refresh();};com.marklogic.widgets.searchresults=function(container){this.container=container;this.ctx=mljs.defaultconnection.createSearchContext();this.selectionMode="append";this.processors={};this.availableProcessors=new Array();this.processorPriority=new Array();this.detailsLink=null;this.lazyId=1;this.lazyLoaders=new Array();this._layout=new com.marklogic.widgets.searchlayouts.default(container);var self=this;this._refresh();this.selectionPublisher=new com.marklogic.events.Publisher();this.highlightPublisher=new com.marklogic.events.Publisher();};com.marklogic.widgets.searchresults.getConfigurationDefinition=function(){return{selectionMode:{type:"enum",default:"append",title:"Selection Mode",description:"If no action happens on click, which selection mode to use.",options:[{value:"append",title:"Append",description:"Append this document to the list of those selection"},{value:"replace",title:"Replace",description:"Replace selection with the selected document only"}]}}};com.marklogic.widgets.searchresults.prototype.setConfiguration=function(config){for(var p in config){this[p]=config[p];}};com.marklogic.widgets.searchresults.prototype.setSearchContext=function(context){this.ctx=context;};com.marklogic.widgets.searchresults.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchresults.prototype.details=function(urlspec){this.detailsLink=urlspec;};com.marklogic.widgets.searchresults.prototype.clear=function(){this.results=null;this._refresh();};com.marklogic.widgets.searchresults.prototype.updateResults=function(results){this.results=results;this._refresh();};com.marklogic.widgets.searchresults.prototype._refresh=function(){if(typeof this.results=="boolean"){if(true==this.results){this._layout.loading();}else{this._layout.failure();}
return;}
this.lazyLoaders=new Array();if(null==this.results||undefined==this.results.results||this.results.results.length==0){this._layout.empty();}else{mljs.defaultconnection.logger.debug("RESULTS OBJECT: "+JSON.stringify(this.results));var settings={};for(var i=0;i<this.results.results.length;i++){var result=this.results.results[i];var found=false;for(var pname in this.processors){mljs.defaultconnection.logger.debug("checking applicability of processor: "+pname);if(this.processors[pname].matcher(result,this,settings)){found=true;mljs.defaultconnection.logger.debug("found processor: "+pname);this._layoutResult(result,this,settings,i,this.processors[pname]);}}
if(!found){for(var pname in com.marklogic.widgets.searchresults.defaultrenderers){if(!found){found=com.marklogic.widgets.searchresults.defaultrenderers[pname].matcher(result,this,settings);if(found){mljs.defaultconnection.logger.debug("found builtin processor: "+pname);this._layoutResult(result,this,settings,i,com.marklogic.widgets.searchresults.defaultrenderers[pname]);}}}}}
for(var i=0;i<this.lazyLoaders.length;i++){var loader=this.lazyLoaders[i];loader.callback(loader.docuri,loader.elid);}
this.lazyLoaders=new Array();}};com.marklogic.widgets.searchresults.prototype.addResultHoverHandler=function(result,elid){var pointer=(null!=this.detailsLink);var self=this;var addPointerHandler=function(id,result){document.getElementById(id).onclick=function(evt){self._navigateTo(result.uri);}};if(!pointer){addPointerHandler=function(id,result){document.getElementById(id).onclick=function(evt){self.selectionPublisher.publish({mode:self.selectionMode,uri:result.uri});}};}
addPointerHandler(elid,result);}
com.marklogic.widgets.searchresults.prototype._layoutResult=function(result,manager,settings,resultindex,processor){var layout=this._layout;var resultContainer=layout.getResultContainer(result,manager,settings,resultindex);var sections=["title","summary","metadata","thumbnail","related","similar","facts"];var replacements=new Array();var replaceXML=function(docuri,elid){document.getElementById(elid).innerHTML=replacements[elid];};mljs.defaultconnection.logger.debug("searchresults._layoutResult: Rendering result: "+result.uri);for(var s=0,maxs=sections.length,section;s<maxs;s++){section=sections[s];var layoutSection=resultContainer[section];mljs.defaultconnection.logger.debug("searchresults._layoutResult:   Rendering section: "+section);if(undefined==processor[section]){if("summary"==section&&undefined!=processor.processor){var returned=processor.processor(result,manager);var resStr="";if(undefined!=returned.nodeType){resStr="<div id='"+this.container+"-searchresults-xml-"+resultindex+"'></div>";replacements[this.container+"-searchresults-xml-"+resultindex]=returned;manager.lazyLoad(result.uri,this.container+"-searchresults-xml-"+resultindex,replaceXML);}else{resStr+=returned;}
document.getElementById(layoutSection).innerHTML=resStr;}else{if("title"==section&&undefined!=processor.processor){document.getElementById(layoutSection).innerHTML="";}else{document.getElementById(layoutSection).innerHTML=com.marklogic.widgets.defaulthtmlsections[section](result,manager,settings);}}}else{document.getElementById(layoutSection).innerHTML=processor[section](result,manager,settings);}}};com.marklogic.widgets.searchlayouts={};com.marklogic.widgets.searchlayouts.default=function(container){this.container=container;this._areas={};this._hasMessage=false;this._uriMap={};this._init();};com.marklogic.widgets.searchlayouts.default.prototype._init=function(){var s="<div id='"+this.container+"-outer' class='mljswidget panel panel-info searchresults mljsResultDefaultOuter'>";s+="<div class='title panel-heading searchresults-title'>Results</div>";s+="<div id='"+this.container+"-inner' class='searchresults-results mljsResultDefaultInner'></div>";s+="</div>";document.getElementById(this.container).innerHTML=s;};com.marklogic.widgets.searchlayouts.default.prototype.reset=function(){document.getElementById(this.container+"-inner").innerHTML="";this._areas={};this._uriMap={};};com.marklogic.widgets.searchlayouts.default.prototype.loading=function(){this._areas={};this._uriMap={};document.getElementById(this.container+"-inner").innerHTML="<div class='searchresults-results'>"+
com.marklogic.widgets.bits.loading(this.container+"-loading")+"</div>";this._hasMessage=true;};com.marklogic.widgets.searchlayouts.default.prototype.failure=function(){this._areas={};this._uriMap={};document.getElementById(this.container+"-inner").innerHTML="<div class='searchresults-results'>"+
com.marklogic.widgets.bits.failure(this.container+"-failure")+"</div>";this._hasMessage=true;};com.marklogic.widgets.searchlayouts.default.prototype.empty=function(){this._areas={};this._uriMap={};document.getElementById(this.container+"-inner").innerHTML="<div class='searchresults-results'>No Results</div>";this._hasMessage=true;};com.marklogic.widgets.searchlayouts.default.prototype.select=function(newsel){for(var uri in this._uriMap){var idx=this._uriMap[uri];if(undefined!=idx){if(newsel.contains(uri)){com.marklogic.widgets.addClass(document.getElementById(this.container+"-result-"+idx+"-summary"),"selected");}else{com.marklogic.widgets.removeClass(document.getElementById(this.container+"-result-"+idx+"-summary"),"selected");}}}};com.marklogic.widgets.searchlayouts.default.prototype.getResultContainer=function(result,manager,settings,resultindex){if(this._hasMessage){document.getElementById(this.container+"-inner").innerHTML="";this._hasMessage=false;}
var area=this._areas[resultindex];if(undefined==area){area={title:this.container+"-result-"+resultindex+"-title",summary:this.container+"-result-"+resultindex+"-summary",metadata:this.container+"-result-"+resultindex+"-metadata",thumbnail:this.container+"-result-"+resultindex+"-thumbnail",related:this.container+"-result-"+resultindex+"-related",similar:this.container+"-result-"+resultindex+"-similar",facts:this.container+"-result-"+resultindex+"-facts"};var s="<div id='"+this.container+"-result-"+resultindex+"' class='";s+="mljsResultDefaultResult'>";s+="<div id='"+this.container+"-result-"+resultindex+"-toprow' class='mljsResultDefaultTopRow'>";s+="<div id='"+this.container+"-result-"+resultindex+"-topleft' class='mljsResultDefaultTopLeft'>";s+="<div id='"+this.container+"-result-"+resultindex+"-title' class='mljsResultDefaultTitle'></div>";s+="<div id='"+this.container+"-result-"+resultindex+"-main' class='mljsResultDefaultMain'>";s+="<div id='"+this.container+"-result-"+resultindex+"-summary' class='mljsResultDefaultSummary'></div>";s+="<div id='"+this.container+"-result-"+resultindex+"-metadata' class='mljsResultDefaultMetadata'></div>";s+="</div>";s+="<div id='"+this.container+"-result-"+resultindex+"-actions' class='mljsResultDefaultActions'></div>";s+="</div>";s+="<div id='"+this.container+"-result-"+resultindex+"-topright' class='mljsResultDefaultTopRight'>";s+="<div id='"+this.container+"-result-"+resultindex+"-thumbnail' class='mljsResultDefaultThumbnail'></div>";s+="</div>";s+="</div>";s+="<div id='"+this.container+"-result-"+resultindex+"-bottomrow' class='mljsResultDefaultBottomRow'>";s+="<div id='"+this.container+"-result-"+resultindex+"-detail' class='mljsResultDefaultDetail hidden'>";s+="<div id='"+this.container+"-result-"+resultindex+"-related' class='mljsResultDefaultRelated hidden'></div>";s+="<div id='"+this.container+"-result-"+resultindex+"-similar' class='mljsResultDefaultSimilar hidden'></div>";s+="<div id='"+this.container+"-result-"+resultindex+"-facts' class='mljsResultDefaultFacts hidden'></div>";s+="</div>";s+="</div>";s+="</div>";com.marklogic.widgets.appendHTML(document.getElementById(this.container+"-inner"),s);this._uriMap[result.uri]=resultindex;manager.addResultHoverHandler(result,this.container+"-result-"+resultindex+"-summary");this._areas[resultindex]=area;}
return area;};com.marklogic.widgets.defaultactions={view:{matcher:function(docuri,manager,settings){return true;},render:function(docuri,manager,settings){return com.marklogic.widgets.defaultactions.view.wrap("<img src='/images/mljs/view-small.png' />",docuri,manager,settings);},wrap:function(html,docuri,manager,settings){return"<a href='/v1/documents?uri="+encodeURI(docuri)+"' target='_blank'>"+html+"</a>";}},viewPrettyXML:{matcher:function(docuri,manager,settings){return true;},render:function(docuri,manager,settings){return com.marklogic.widgets.defaultactions.viewPrettyXML.wrap("<img src='/images/mljs/view-pretty-small.png' />",docuri,manager,settings);},wrap:function(html,docuri,manager,settings){return"<a href='/v1/documents?transform=xmltohtml&uri="+encodeURI(docuri)+"' target='_blank'>"+html+"</a>";}},explore:{}};com.marklogic.widgets.defaulthtmlsections={title:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultTitle(result,manager,settings);},summary:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultSummary(result,manager,settings);},metadata:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultMetadata(result,manager,settings);},actions:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultActions(result,manager,settings);},thumbnail:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultThumbnail(result,manager,settings);},similar:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultSimilar(result,manager,settings);},related:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultRelated(result,manager,settings);},comments:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultComments(result,manager,settings);},facts:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultRelatedTriples(result,manager,settings);}};com.marklogic.widgets.defaulthtmlrenderer={defaultSearchResult:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.wrapSearchResult(com.marklogic.widgets.defaulthtmlrenderer.genericTitle(result.index,result.uri)+
com.marklogic.widgets.searchhelper.snippet(result),result,manager,settings);},defaultTitle:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.genericTitle(result.index,result.uri);},defaultSummary:function(result,manager,settings){mljs.defaultconnection.logger.debug("defaulthtmlrenderer.defaultSummary");if(undefined!=result.matches){return com.marklogic.widgets.defaulthtmlrenderer.genericTitle(result.index,result.uri)+com.marklogic.widgets.searchhelper.snippet(result);}else{for(var r in com.marklogic.widgets.searchresults.defaultrenderers){var renderer=com.marklogic.widgets.searchresults.defaultrenderers[r];if(renderer.matcher(result,manager,settings)){return com.marklogic.widgets.defaulthtmlrenderer.genericTitle(result.index,result.uri)+renderer.processor(result,manager,settings);}}}},defaultMetadata:function(result,manager,settings){var s="";if(undefined!=result.metadata){var count=0;for(var metai=0,maxi=result.metadata.length,meta;metai<maxi;metai++){meta=result.metadata[metai];for(var p in meta){if("metadata-type"!=p){var value=meta[p];if(null!=value){var name=p;if(name.substring(0,1)=="{"){name=name.substring(name.indexOf("}")+1);}
var opts=manager.ctx.getOptions();var con=opts._findConstraint(name);if(undefined!=con){var annotation=con.annotation;if(undefined==annotation){name=name;}else{name=annotation[0];}}
if(count>0){s+=", ";}
s+=" <b>"+name+":</b> "+value;count++;}}}}}
return s;},defaultActions:function(result,manager,settings){return"";},defaultThumbnail:function(result,manager,settings){return"";},defaultSimilar:function(result,manager,settings){return"";},defaultRelated:function(result,manager,settings){return"";},defaultComments:function(result,manager,settings){return"";},defaultRelatedTriples:function(result,manager,settings){return"";},defaultSummaryTriples:function(result,manager,settings){var s="";var xml=textToXML(result.content);var resolver=function(prefix){if(prefix==="sem"){return"http://marklogic.com/semantics";}else{return null;}};var iterator=xml.evaluate("//sem:triple",xml,resolver,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null);var child=iterator.iterateNext();var first=true;while(child){var subject="",predicate="",obj="";for(var n=0;n<child.childNodes.length;n++){var gc=child.childNodes.item(n);if(1==gc.nodeType){if("sem:subject"==gc.nodeName){subject=gc.textContent;}else if("sem:predicate"==gc.nodeName){predicate=gc.textContent;}else if("sem:object"==gc.nodeName){obj=gc.textContent;}}}
if(!first){s+="<br/>";}else{first=false;}
s+="Subject: "+subject+", Predicate: "+predicate+", Object: "+obj;child=iterator.iterateNext();}
return s;},defaultSearchResultTriples:function(result,manager,settings){var s=com.marklogic.widgets.defaulthtmlrenderer.wrapTitle(result.index+". Subgraph "+result.uri,result,manager,settings);s+=com.marklogic.widgets.defaulthtmlrenderer.defaultSummaryTriples(result,manager,settings);return com.marklogic.widgets.defaulthtmlrenderer.wrapSearchResult(s,result,manager,settings);},defaultSearchResultXML:function(result,manager,settings){manager.ctx.db.logger.debug("defaulthtmlrenderer.defaultSearchResultXML");try{var xmlDoc=textToXML(result.content);manager.ctx.db.logger.debug("successfully converted xml text to XML doc");var title=result.uri;manager.ctx.db.logger.debug("title initially: "+title);var snippet=null;if(undefined!=xmlDoc.evaluate){var evalResult=xmlDoc.evaluate("//title[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("//name[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("//id[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("//h1[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("(//text())[1]",xmlDoc,null,XPathResult.STRING_TYPE,null);}}}}
if(undefined!=evalResult&&null!=evalResult&&undefined!=evalResult.stringValue&&""!=evalResult.stringValue){title=evalResult.stringValue;}
manager.ctx.db.logger.debug("title after eval: "+title);evalResult=xmlDoc.evaluate("//summary[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("//synopsis[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("//description[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("//details[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){evalResult=xmlDoc.evaluate("(//text())[2]",xmlDoc,null,XPathResult.STRING_TYPE,null);}}}}
if(undefined!=evalResult&&null!=evalResult&&undefined!=evalResult.stringValue&&""!=evalResult.stringValue){snippet=evalResult.stringValue;}}
manager.ctx.db.logger.debug("content currently: "+snippet);if(null==snippet){manager.ctx.db.logger.debug("setting content to full XML doc as html");snippet=com.marklogic.widgets.searchhelper.xmltohtml(xmlDoc);}
if(null==snippet){snippet=result.content;}
manager.ctx.db.logger.debug("content finally: "+snippet);var resStr=com.marklogic.widgets.defaulthtmlrenderer.wrapTitle(result.index+". "+title,result,manager,settings);if(null!=snippet){resStr+=com.marklogic.widgets.defaulthtmlrenderer.wrapSummary(snippet,result,manager,settings);}
return com.marklogic.widgets.defaulthtmlrenderer.wrapSearchResult(resStr,result,manager,settings);}catch(err){manager.ctx.db.logger.debug("defaultProcessor: XML mode: Failed to create XML document from text: "+result.content);}
return"";},defaultSearchResultHTML:function(result,manager,settings){var titleStart=result.content.indexOf("title>");var titleEnd=result.content.indexOf("title>",titleStart+6);var bodyStart=result.content.indexOf("body");var bodyEnd=result.content.indexOf(">",bodyStart+4);var endBodyStart=result.content.indexOf("body",bodyEnd+1);var bodyContent=result.content.substring(bodyEnd+1,endBodyStart-2);manager.ctx.db.logger.debug("bodyContent: "+bodyContent);var title=result.uri;if(-1!=titleStart&&-1!=titleEnd){title=result.content.substring(titleStart+6,titleEnd-2);}else{var firstElStart=bodyContent.indexOf("<");var firstElEnd=bodyContent.indexOf(">",firstElStart+1);var endFirstElStart=bodyContent.indexOf("</",firstElEnd);if(-1!=firstElStart&&-1!=firstElEnd&&-1!=endFirstElStart){title=bodyContent.substring(firstElEnd+1,endFirstElStart);}}
var titleHtml=com.marklogic.widgets.defaulthtmlrenderer.wrapTitle(result.index+". "+title,result,manager,settings);var summaryHtml=com.marklogic.widgets.defaulthtmlrenderer.wrapSummary(bodyContent,result,manager,settings);manager.ctx.db.logger.debug("defaultSearchResultHTML: title: "+titleHtml);manager.ctx.db.logger.debug("defaultSearchResultHTML: summary: "+summaryHtml);var theHtml=com.marklogic.widgets.defaulthtmlrenderer.wrapSearchResult(titleHtml+summaryHtml,result,manager,settings);manager.ctx.db.logger.debug("defaultSearchResultHTML: all: "+theHtml);return theHtml;},defaultSearchResultText:function(result,manager,settings){var resStr=com.marklogic.widgets.defaulthtmlrenderer.genericTitle(result.index,result.uri);if(undefined==result.content){}else{if(result.content.length<=100){resStr+=result.content;}else{resStr+=result.content.substring(0,100)+"...";}}
return resStr;},defaultSearchResultJSON:function(result,manager,settings){try{var json=result.content;if("string"==typeof(json)){json=JSON.parse(json);}
return com.marklogic.widgets.searchhelper.handleJson(result,json);}catch(err){}
return"";},defaultSearchResultSVG:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.wrapSearchResult(com.marklogic.widgets.defaulthtmlrenderer.genericSVG(result.content),result,manager,settings);},wrapSearchResult:function(inner,result,manager,settings){return"<div class='searchresults-result'>"+inner+"</div>";},wrapTitle:function(inner,result,manager,settings){return"<div class='h4'>"+inner+"</div>";},wrapSummary:function(inner,result,manager,settings){return"<div class='searchresults-snippet'>"+inner+"</div>";},wrapAction:function(action,inner,result,manager,settings){},genericTitle:function(index,docuri){return"<div class='h4'>"+index+". "+docuri+"</div>";},genericSVG:function(svg){return"<div style='height: 200px;position:relative;'>"+svg+"</div>";},getMetadata:function(result,param){if(undefined==result.metadata){return null;}
for(var metai=0,maxi=result.metadata.length,meta;metai<maxi;metai++){meta=result.metadata[metai];for(var p in meta){if(p==param){return meta[p];}}}
return null;},getMetadataConstraint:function(result,constraintName){return com.marklogic.widgets.defaulthtmlrenderer.getMetadata(result,constraintName);},getMetadataElement:function(result,element,namespace_opt){return com.marklogic.widgets.defaulthtmlrenderer.getMetadata(result,"{"+(namespace_opt||"")+"}"+element);}};com.marklogic.widgets.searchresults.defaultrenderers={json:{matcher:function(result,manager,settings){return("json"==result.format&&undefined==result.matches);},processor:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResultJSON(result,manager,settings);}},snippet:{matcher:function(result,manager,settings){return(undefined!=result.matches&&undefined!=result.matches[0]&&undefined!=result.matches[0]["match-text"]&&undefined!=result.matches[0]["match-text"][0]);},processor:function(result,manager,settings){return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResult(result,manager,settings);}},svg:{matcher:function(result){var xml=null;if("string"==typeof result.content){xml=textToXML(result.content);}else if("object"==typeof result.content&&undefined!=result.content.nodeType){xml=result.content;}
if(null!=xml){if(xml.childNodes[0].nodeName=="svg"){mljs.defaultconnection.logger.debug("Potential SVG nodeName: "+xml.childNodes[0].nodeName);mljs.defaultconnection.logger.debug("Potential SVG nodeType: "+xml.childNodes[0].nodeType);return true;}else{return false;}}
return false;},processor:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResultSVG(result,manager,settings);},summary:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.genericSVG(result.content);}},html:{matcher:function(result,manager,settings){return("string"==typeof result.content&&-1!=result.content.substring(0,100).indexOf("<html"));},processor:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResultHTML(result,manager,settings);}},triples:{matcher:function(result,manager,settings){if(undefined==result.content){return false;}
return("<sem:triples"==result.content.substring(0,12));},processor:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResultTriples(result,manager,settings);}},xml:{matcher:function(result,manager,settings){return("xml"==result.format);},processor:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResultXML(result,manager,settings);}},text:{matcher:function(result,manager,settings){return("text"==result.format);},processor:function(result,manager,settings){if(undefined!=result.matches){return com.marklogic.widgets.searchhelper.snippet(result);}
return com.marklogic.widgets.defaulthtmlrenderer.defaultSearchResultText(result,manager,settings);}}};com.marklogic.widgets.searchresults.prototype.generateLazyID=function(){return this.lazyId++;};com.marklogic.widgets.searchresults.prototype.lazyLoad=function(docuri,elid,callback){this.lazyLoaders.push({docuri:docuri,elid:elid,callback:callback});};com.marklogic.widgets.searchresults.prototype._navigateTo=function(uri){var go=this.detailsLink.replace("#URI#",uri);window.location=go;};com.marklogic.widgets.searchresults.prototype.addResultHighlightListener=function(sl){this.highlightPublisher.subscribe(sl);};com.marklogic.widgets.searchresults.prototype.removeResultHighlightListener=function(sl){this.highlightPublisher.unsubscribe(sl);};com.marklogic.widgets.searchresults.prototype.addResultSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchresults.prototype.removeResultSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchresults.prototype.addProcessor=function(name,matcher_func,processor_func){if(undefined==processor_func&&typeof(matcher_func)=="object"){this.processors[name]=matcher_func}else{this.processors[name]={matcher:matcher_func,processor:processor_func};this.availableProcessors.push(name);this.processorPriority.push(name);}};com.marklogic.widgets.searchresults.prototype.removeProcessor=function(name){this.processors[name]=undefined;this.availableProcessors.remove(name);this.processorPriority.remove(name);};com.marklogic.widgets.searchresults.prototype.setProcessorPriority=function(procNameArray){this.processorPriority=procNameArray;};com.marklogic.widgets.searchresults.prototype.updateResultSelection=function(newsel){if(undefined==this.results||undefined==this.results.results){return;}
this._layout.select(newsel);};com.marklogic.widgets.searchresults.prototype.updateResultHighlight=function(newhigh){if(undefined==this.results||undefined==this.results.results){return;}
for(var i=0;i<this.results.results.length;i++){var wrapperId=this.container+"-searchresults-wrapper-"+i;var result=this.results.results[i];if(newhigh.contains(result.uri)){com.marklogic.widgets.addClass(document.getElementById(wrapperId),"highlighted");}else{com.marklogic.widgets.removeClass(document.getElementById(wrapperId),"highlighted");}}};com.marklogic.widgets.searchpager=function(container){this.container=container;this.perPage=10;this.start=0;this.total=0;this.ctx=mljs.defaultconnection.createSearchContext();this.pagePublisher=new com.marklogic.events.Publisher();document.getElementById(container).innerHTML="<div class='mljswidget searchpager'><span class='searchpager-showing' id='"+container+"-searchpager-showing'></span>"+"<a href='#' id='"+container+"-searchpager-first-a' class='searchpager-link'><span class='glyphicon glyphicon-step-backward searchpager-first searchpager-button' id='"+container+"-searchpager-first'> </span></a>"+"<a href='#' id='"+container+"-searchpager-previous-a' class='searchpager-link'><span class='glyphicon glyphicon-chevron-left searchpager-previous searchpager-button' id='"+container+"-searchpager-previous'> </span></a>"+"<span class='searchpager-page' id='"+container+"-searchpager-page'>-</span>"+"<a href='#' id='"+container+"-searchpager-next-a' class='searchpager-link'><span class='glyphicon glyphicon-chevron-right searchpager-next searchpager-button' id='"+container+"-searchpager-next'> </span></a>"+"<a href='#' id='"+container+"-searchpager-last-a' class='searchpager-link'><span class='glyphicon glyphicon-step-forward searchpager-last searchpager-button' id='"+container+"-searchpager-last'> </span></a></div>";var self=this;document.getElementById(container+"-searchpager-first-a").onclick=function(){self._first();};document.getElementById(container+"-searchpager-previous-a").onclick=function(){self._previous();};document.getElementById(container+"-searchpager-next-a").onclick=function(){self._next();};document.getElementById(container+"-searchpager-last-a").onclick=function(){self._last();};this._refresh();};com.marklogic.widgets.searchpager.getConfigurationDefinition=function(){return{};};com.marklogic.widgets.searchpager.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.searchpager.prototype.setSearchContext=function(context){this.ctx=context;};com.marklogic.widgets.searchpager.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchpager.prototype.clear=function(){this.updatePage(null);};com.marklogic.widgets.searchpager.prototype.updatePage=function(results){mljs.defaultconnection.logger.debug("updatePage: results: "+results);if("boolean"==typeof results){return;}
if(null==results){this.start=1;this.total=0;}else{this.perPage=results["page-length"];this.start=results.start;this.total=results.total;}
this._refresh();};com.marklogic.widgets.searchpager.prototype.addPageListener=function(l){this.pagePublisher.subscribe(l);};com.marklogic.widgets.searchpager.prototype.removePageListener=function(l){this.pagePublisher.unsubscribe(l);};com.marklogic.widgets.searchpager.prototype._refresh=function(){mljs.defaultconnection.logger.debug("REFRESH: start: "+this.start+", total: "+this.total+", perPage: "+this.perPage);var last=(this.start+this.perPage-1);if(last>this.total){last=this.total;}
var st=this.start;if(st>this.total){st=this.total;}
if(0==st){document.getElementById(this.container+"-searchpager-showing").innerHTML="Showing no results";}else{document.getElementById(this.container+"-searchpager-showing").innerHTML="Showing "+st+" to "+last+" of "+this.total;}
var page=Math.ceil(st/this.perPage);var maxpage=Math.ceil(this.total/this.perPage);if(0==st){page=0;maxpage=0;}
if(0==page){document.getElementById(this.container+"-searchpager-page").innerHTML=" - ";}else{document.getElementById(this.container+"-searchpager-page").innerHTML="Page "+page+" of "+maxpage;}
if(page<2){}else if(page==maxpage){}};com.marklogic.widgets.searchpager.prototype._fire=function(){this._refresh();var json={start:this.start,show:this.perPage};this.pagePublisher.publish(json);};com.marklogic.widgets.searchpager.prototype._first=function(){this.start=1;this._fire();};com.marklogic.widgets.searchpager.prototype._previous=function(){this.start=this.start-this.perPage;if(this.start<1){this.start=1;}
this._fire();};com.marklogic.widgets.searchpager.prototype._next=function(){this.start=this.start+this.perPage;var lastpage=1+Math.floor(this.total/this.perPage);mljs.defaultconnection.logger.debug("start now: "+this.start+", lastpage: "+lastpage);if(Math.floor(this.start/this.perPage)>lastpage){mljs.defaultconnection.logger.debug("new page greater than maxpage");this.start=1+Math.floor(this.perPage*(lastpage-1));mljs.defaultconnection.logger.debug("start now now: "+this.start);}
this._fire();};com.marklogic.widgets.searchpager.prototype._last=function(){var lastpage=1+Math.floor(this.total/this.perPage);this.start=1+Math.floor(this.perPage*(lastpage-1));this._fire();};com.marklogic.widgets.searchsort=function(container){this.container=container;this.ctx=mljs.defaultconnection.createSearchContext();this.initialised=false;this.selectedValue=null;this.selectionPublisher=new com.marklogic.events.Publisher();this.sortOptions=new Array();this._refresh();};com.marklogic.widgets.searchsort.getConfigurationDefinition=function(){return{}};com.marklogic.widgets.searchsort.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.searchsort.prototype.setSearchContext=function(context){this.ctx=context;};com.marklogic.widgets.searchsort.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchsort.prototype._refresh=function(){var selid=this.container+"-searchsort-select";var str="<div class='mljswidget input-prepend searchsort'>"+"<span class='searchsort-text'>Sort: </span>"+"<select class='form-control searchsort-select' id='"+selid+"'>";for(var i=0;i<this.sortOptions.length;i++){var selected=false;if(this.selectedValue==null){selected=true;this.selectedValue=this.sortOptions[i];}else{selected=((this.selectedValue["json-key"]==this.sortOptions[i]["json-key"])&&(this.selectedValue["element"]==this.sortOptions[i]["element"])&&(this.selectedValue["attribute"]==this.sortOptions[i]["attribute"])&&(this.selectedValue["field"]==this.sortOptions[i]["field"])&&(this.selectedValue["direction"]==this.sortOptions[i]["direction"]))}
var o=this.sortOptions[i];str+="<option value='"+i+"'";if(selected){str+=" selected='selected'";}
str+=">";var title="";var val="";if(undefined!=o["json-key"]){val=o["json-key"];}
if(undefined!=o.element){if(undefined!=o.attribute){val=o["attribute"].name;}else{val=o["element"].name;}}
if(undefined!=o.field){val=o["field"].name;}
if(undefined!=o.annotation&&undefined!=o.annotation[0]){title=o.annotation[0];}
if(undefined==title||""==title){title=com.marklogic.widgets.searchhelper.processValueAll(val);if(""!=title&&undefined!=o.direction){var dir=com.marklogic.widgets.searchhelper.camelcase(o.direction,"all");if("Ascending"==dir){dir="Asc";}else if("Descending"==dir){dir="Desc";}
title+=" ("+dir+")";}else{}}
if(""==title){title="None";}
str+=title;}
str+="</select></div>";document.getElementById(this.container).innerHTML=str;var self=this;var sel=document.getElementById(selid);sel.onchange=function(evt){self._updateSortSelect(sel.value);};};com.marklogic.widgets.searchsort.prototype._updateSortSelect=function(index){var value=this.sortOptions[index];this.selectedValue=value;mljs.defaultconnection.logger.debug("searchsort: publishing selected sort option: "+JSON.stringify(value));this.selectionPublisher.publish(value);};com.marklogic.widgets.searchsort.prototype.addSortListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchsort.prototype.removeSortListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchsort.prototype.updateSort=function(sortSelection){};com.marklogic.widgets.searchsort.prototype.updateOptions=function(options){mljs.defaultconnection.logger.debug("searchsort: updateOptions: "+JSON.stringify(options));mljs.defaultconnection.logger.debug("searchsort: initalised yet?: "+this.initialised);if(this.initialised)return;this.initialised=true;var so=options["sort-order"];this.sortOptions=new Array();if(undefined!=so){for(var i=0;i<so.length;i++){this.sortOptions.push(so[i]);}}
this._refresh();};com.marklogic.widgets.selection=function(container){this.container=container;this._selected=new Array();this._refresh();};com.marklogic.widgets.selection.getConfigurationDefinition=function(){return{};};com.marklogic.widgets.selection.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.selection.prototype._refresh=function(){var str="<div id='"+this.container+"-selection' class='mljswidget panel panel-info selection'>";str+="<div class='title panel-heading selection-title'>Selected Documents</div>";str+="<div class='panel-body selection-content'>";if(0==this._selected.length){str+="<i>None Selected</i>";}else{for(var i=0,max=this._selected.length,sel;i<max;i++){sel=this._selected[i];str+="<p>"+sel+"</p>";}}
str+="</div></div>";document.getElementById(this.container).innerHTML=str;};com.marklogic.widgets.selection.prototype.updateDocumentSelection=function(newsel){this._selected=newsel;this._refresh();};com.marklogic.widgets.searchpage=function(container){this.container=container;document.getElementById(container).innerHTML="<div class='container_12 searchpage-inner'>"+"<div id='"+container+"-facets' class='grid_4 searchpage-facets'> </div> "+"<div id='"+container+"-main' class='grid_8 searchpage-main'>"+"<div id='"+container+"-bar' class='searchpage-bar'></div>"+"<div class='searchpage-controls'>"+"<div class='searchpage-controls-inner'>"+"<div id='"+container+"-pager' class='grid_5 alpha searchpage-pager'></div>"+"<div id='"+container+"-sort' class='grid_3 omega searchpage-sort'></div>"+"</div>"+"</div>"+"<div id='"+container+"-results' class='searchpage-results'></div>"+"</div></div>";this.context=mljs.defaultconnection.createSearchContext();this.bar=new com.marklogic.widgets.searchbar(container+"-bar");this.facets=new com.marklogic.widgets.searchfacets(container+"-facets");this.pager=new com.marklogic.widgets.searchpager(container+"-pager");this.sort=new com.marklogic.widgets.searchsort(container+"-sort");this.results=new com.marklogic.widgets.searchresults(container+"-results");var self=this;this.context.register(this.bar);this.context.register(this.sort);this.context.register(this.facets);this.context.register(this.pager);this.context.register(this.results);this.db=mljs.defaultconnection;};com.marklogic.widgets.searchpage.prototype.setSearchContext=function(ctx){this.context=ctx;this.context.register(this.bar);this.context.register(this.sort);this.context.register(this.facets);this.context.register(this.pager);this.context.register(this.results);};com.marklogic.widgets.searchpage.prototype.getSearchContext=function(){return this.context;};com.marklogic.widgets.searchpage.prototype.setOptions=function(name,options,check_options_exist){this.context.setOptions(name,options);};com.marklogic.widgets.searchpage.prototype.execute=function(){this.context.dosimplequery();};com.marklogic.widgets.searchpage.prototype.setConnection=function(connection){this.db=connection;this.context.setConnection(connection);};com.marklogic.widgets.searchpage.reset=function(){this.context.reset();};com.marklogic.widgets.searchselection=function(container){this.container=container;this._config={title:"Relevancy Method: ",mode:"replace"};this._queries={};this._selectedQuery=null;this._refresh();this.ctx=mljs.defaultconnection.createSearchContext();};com.marklogic.widgets.searchselection.getConfigurationDefinition=function(){return{title:{type:"string",default:"Relevancy Method: ",title:"Title",description:"How to describe the drop down."},mode:{type:"enum",default:"replace",title:"Mode",description:"Are we replacing the search or contributing to it.",options:[{value:"replace",title:"Replace",description:"Replace the search with the one selected"},{value:"contribute",title:"Contribute",description:"Contribute this query to the search"}]}};};com.marklogic.widgets.searchselection.prototype.setConfiguration=function(config){for(var prop in config){this._config[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.searchselection.prototype.setSearchContext=function(ctx){this.ctx=ctx;};com.marklogic.widgets.searchselection.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchselection.prototype._config=function(){};com.marklogic.widgets.searchselection.prototype._refresh=function(){var selid=this.container+"-searchselection-select";var str="<div id='"+this.container+"-searchselection' class='mljswidget well searchselection'>";str+="<span class='searchselection-text'>"+this._config.title+"</span>"+"<select class='searchselection-select' id='"+selid+"'>";for(var name in this._queries){str+="<option value='"+name+"'";if(name==this._selectedQuery){str+=" selected='selected'";}
str+=">"+name+"</option>";}
str+="</select>";str+="</div>";document.getElementById(this.container).innerHTML=str;var self=this;var sel=document.getElementById(selid);sel.onchange=function(evt){self.__selection(sel.value);};};com.marklogic.widgets.searchselection.prototype.addQuery=function(name,jsonOrFunction){this._queries[name]=jsonOrFunction;this._refresh();};com.marklogic.widgets.searchselection.prototype.removeQuery=function(name){this._queries[name]=undefined;this._refresh();};com.marklogic.widgets.searchselection.prototype.__selection=function(selvalue){this._selectedQuery=selvalue;this.__doquery();};com.marklogic.widgets.searchselection.prototype.__doquery=function(){if(null==this._selectedQuery){var first=null;for(var name in this._queries){if(null==first){first=name;}}
if(null==first){return;}else{this._selectedQuery=first;this._refresh();}}
var q=this._queries[this._selectedQuery];var query=null;if("function"===typeof(q)){mljs.defaultconnection.logger.debug("searchselection.__doquery: Calling query function");query=q();}else if("object"===typeof(q)){mljs.defaultconnection.logger.debug("searchselection.__doquery: Setting query value");query=q;}
mljs.defaultconnection.logger.debug("searchselection.__doquery: Query now: "+JSON.stringify(query));if("contribute"==this._config.mode){mljs.defaultconnection.logger.debug("searchselection.__doquery: Contributing Query");this.ctx.contributeStructuredQuery(this.container,query,1);}else{mljs.defaultconnection.logger.debug("searchselection.__doquery: Overwriting Query");this.ctx.doStructuredQuery(query);}};com.marklogic.widgets.searchselection.prototype.setModeContributeStructured=function(){this._mode="contribute";};com.marklogic.widgets.searchmetrics=function(container){this.container=container;this.ctx=mljs.defaultconnection.createSearchContext();this.updateResults(false);};com.marklogic.widgets.searchmetrics.getConfigurationDefinition=function(){return{};};com.marklogic.widgets.searchmetrics.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.searchmetrics.prototype.updateResults=function(results){var str="";if("boolean"==typeof(results)){if(results){str+=com.marklogic.widgets.bits.loading(this.container+"-loading");}else{}}else{if(undefined!=results.metrics){var time=results.metrics["total-time"];var time=time.substring(2,time.length-1);str+="Search completed in "+time+" seconds";}else{mljs.defaultconnection.logger.debug("searchmetrics.updateResults: Results REST API JSON doesn't contain search metrics. Did you set up the search options correctly?");}}
document.getElementById(this.container).innerHTML=str;};