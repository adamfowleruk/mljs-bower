
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.markings=function(container){this.container=container;this.errorPublisher=new com.marklogic.events.Publisher();this.tripleEditor=false;this._permissions=new Array();this._updatepermissions=new Array();this._uriHandlers=new Array();this.sections=new Array();this.head="";this.validTriples=new Array();this.validTriples.push({subjectType:"person",objectType:"person",predicateArray:["knows","friendOf","enemyOf","childOf","parentOf","fundedBy"]});this.validTriples.push({subjectType:"person",objectType:"organisation",predicateArray:["member","studies_at"]});this.validTriples.push({subjectType:"organisation",objectType:"organisation",predicateArray:["member","parentOf","affiliated_with","fundedBy"]});this.validTriples.push({subjectType:"person",objectType:"placename",predicateArray:["based_near"]});this.validTriples.push({subjectType:"organisation",objectType:"placename",predicateArray:["based_near","has_meetings_near"]});this.validTriples.push({subjectType:"placename",objectType:"placename",predicateArray:["located_within","contains_location"]});this._predicates=new Array();this._predicates["knows"]="http://xmlns.com/foaf/0.1/knows";this._predicates["friendOf"]="http://xmlns.com/foaf/0.1/friendOf";this._predicates["enemyOf"]="http://xmlns.com/foaf/0.1/enemyOf";this._predicates["childOf"]="http://xmlns.com/foaf/0.1/childOf";this._predicates["parentOf"]="http://xmlns.com/foaf/0.1/parentOf";this._predicates["fundedBy"]="http://xmlns.com/foaf/0.1/fundedBy";this._predicates["member"]="http://xmlns.com/foaf/0.1/member";this._predicates["based_near"]="http://xmlns.com/foaf/0.1/based_near";this._predicates["studies_at"]="http://www.marklogic.com/ontology/0.1/studies_at";this._predicates["affiliated_with"]="http://www.marklogic.com/ontology/0.1/affiliated_with";this._predicates["has_meetings_near"]="http://www.marklogic.com/ontology/0.1/has_meetings_near";this._predicates["located_within"]="http://www.marklogic.com/ontology/0.1/located_within";this._predicates["contains_location"]="http://www.marklogic.com/ontology/0.1/contains_location";this._tripleCollections=new Array();this._tripleIDs=new Array();this._tripleSection=new Array();this.nextTripleId=1;this._iriPatterns=new Array();this._iriPatterns["person"]="http://marklogic.com/semantic/targets/person/#VALUE#";this._iriPatterns["organisation"]="http://marklogic.com/semantic/targets/organisation/#VALUE#";this._iriPatterns["placename"]="http://marklogic.com/semantic/targets/placename/#VALUE#";this._rdfTypes=new Array();this._rdfTypes["person"]="http://xmlns.com/foaf/0.1/Person";this._rdfTypes["organisation"]="http://xmlns.com/foaf/0.1/Organization";this._rdfTypes["placename"]="http://schema.org/Place";this._commonNamePredicates=new Array();this._commonNamePredicates["person"]="http://xmlns.com/foaf/0.1/name";this._commonNamePredicates["organisation"]="http://xmlns.com/foaf/0.1/name";this._commonNamePredicates["placename"]="http://www.geonames.org/ontology#name";this._init();};com.marklogic.widgets.markings.prototype.addErrorListener=function(fl){this.errorPublisher.subscribe(fl);};com.marklogic.widgets.markings.prototype.removeErrorListener=function(fl){this.errorPublisher.unsubscribe(fl);};com.marklogic.widgets.markings.prototype.tripleCollections=function(collections){this._tripleCollections=collections;};com.marklogic.widgets.markings.prototype._init=function(){var id=this.container+"-markings";var html="<div id='"+id+"'>"+"<div id='"+id+"-docinfo' class='markings-docinfo'>&nbsp;</div>"+"<div id='"+id+"-doccontent' class='markings-doccontent'>&nbsp;</div>"+"</div>";document.getElementById(this.container).innerHTML=html;};com.marklogic.widgets.markings.prototype.triples=function(bool){this.tripleEditor=bool;};com.marklogic.widgets.markings.prototype.uriHandler=function(metafield,urlreplace){this._uriHandlers[metafield]=urlreplace;};com.marklogic.widgets.markings.prototype.permissions=function(list){this._permissions=list;};com.marklogic.widgets.markings.prototype.updatePermissions=function(list){this._updatepermissions=list;};com.marklogic.widgets.markings.prototype.showDocument=function(uri){this.docuri=uri;this.sections=new Array();this.head="";var hid=this.container+"-markings-docinfo";document.getElementById(hid).innerHTML="<h2 class='markings-meta-title'>Document Extracted Metadata</h2>"+com.marklogic.widgets.bits.loading(hid+"-loading1")+"<h2 class='markings-security-title'>Document Security Information</h2>"+com.marklogic.widgets.bits.loading(hid+"-loading2");var cid=this.container+"-markings-doccontent";document.getElementById(cid).innerHTML="<h2 class='markings-content-title'>Document Secure Content</h2>"+com.marklogic.widgets.bits.loading(cid+"-loading");var self=this;mljs.defaultconnection.get(uri,{transform:"redaction"},function(result){var xml=result.doc;var head=xml.getElementsByTagName("head")[0];self.head="<head xmlns='http://www.w3.org/1999/xhtml'>";for(var c=0;c<head.childNodes.length;c++){self.head+=(new XMLSerializer()).serializeToString(head.childNodes.item(c));}
self.head+="</head>";var count=0;var s="";var titleEl=head.getElementsByTagName("title");var title=uri;if(titleEl.length>0&&null!=titleEl[0]&&null!=titleEl[0].nodeValue){title=titleEl[0].nodeValue;}
var subjectEl=head.getElementsByTagName("Subject");if(subjectEl.length>0&&null!=subjectEl[0]&&null!=subjectEl[0].nodeValue){title=subjectEl[0].nodeValue;}
s+="<h2 class='markings-meta-title'>Document Extracted Metadata</h2> <table class='markings-meta-table'><tr>";var metas=head.getElementsByTagName("meta");var columns=2;var width=100/(2*columns);var firstRow=true;var mname,mvalue,mreplace;for(var m=0;m<metas.length;m++){var meta=metas[m];if(count>=columns){s+="</tr><tr>";count=count%columns;firstRow=false;}
count++;s+="<td";if(firstRow){s+=" style='width: "+(0.8*width)+"%;'";}
mname=meta.getAttribute("name");s+="><b>"+mname+":</b> </td><td"
if(firstRow){s+=" style='width: "+(1.2*width)+"%;'";}
mvalue=meta.getAttribute("content");mreplace=self._uriHandlers[mname];if(undefined!=mreplace){mvalue="<a href='"+mreplace.replace("#URI#",encodeURI(mvalue))+"'>"+mvalue+"</a>";}
s+=">"+mvalue+"</td>";}
for(;count<columns;count++){s+="<td";if(firstRow){s+=" style='width: "+(0.8*width)+"%;'";}
s+=">&nbsp;</td>";s+="<td";if(firstRow){s+=" style='width: "+(1.2*width)+"%;'";}
s+=">&nbsp;</td>";}
s+="</tr></table>";s+="<h2 class='markings-security-title'>Document Security Information</h2> <div class='markings-security-rolecontainer'>";var readperm="confidential-read";var updateperm="confidential-write";var secinfo="<label for='"+self.container+"-markings-security-read'>Role for Read access: </label>";secinfo+="<select id='"+self.container+"-markings-security-read'>";for(var p=0;p<self._permissions.length;p++){secinfo+="<option value='"+self._permissions[p];console.log("this perm: '"+self._permissions[p]+"'");if(readperm==self._permissions[p]){secinfo+="' selected='selected";}
secinfo+="'>"+self._permissions[p]+"</option>";}
secinfo+="</select>";s+=secinfo;secinfo="<label for='"+self.container+"-markings-security-update'>Role for Update access: </label>";secinfo+="<select id='"+self.container+"-markings-security-read'>";for(var p=0;p<self._updatepermissions.length;p++){secinfo+="<option value='"+self._updatepermissions[p];console.log("this perm: '"+self._updatepermissions[p]+"'");if(updateperm==self._updatepermissions[p]){secinfo+="' selected='selected";}
secinfo+="'>"+self._updatepermissions[p]+"</option>";}
secinfo+="</select>";s+=secinfo+"</div>";document.getElementById(hid).innerHTML=s;var s="";var body=xml.getElementsByTagName("body")[0];var allSecure=true;if(undefined!=body){for(var c=0;allSecure&&c<body.childNodes.length;c++){console.log("nodeName: "+body.childNodes.item(c).nodeName);allSecure=allSecure&&(body.childNodes.item(c).nodeName=="div");}}
console.log("All secure content?: "+allSecure);if(!allSecure){console.log("Creating new body element");var ds="<body>";var buffer="";var gotH=false;for(var c=0;c<body.childNodes.length;c++){var n=body.childNodes.item(c);console.log("  Got child node: "+n.nodeName+" type: "+n.nodeType);var isPHeading=("p"==n.nodeName&&n.childNodes.length==1&&n.childNodes.item(0).nodeName=="#text"&&n.childNodes.item(0).nodeValue.split(" ").length<6&&n.childNodes.item(0).nodeValue.trim().length>0);if(1==n.nodeType){if("h1"==n.nodeName||"h2"==n.nodeName||"h3"==n.nodeName||"h4"==n.nodeName||"h5"==n.nodeName||"h6"==n.nodeName||isPHeading){if(!gotH){if(buffer.length>0){ds+="<div ";var secid="secure-content-"+c;ds+="id='"+secid+"' ";ds+="class='secure-content role:"+self._permissions[0]+"'>";ds+=buffer;ds+="</div>";}
buffer="";}
gotH=true;}else{gotH=false;}
if(isPHeading){buffer+="<h2>"+n.childNodes.item(0).nodeValue+"</h2>";}else{if("p"==n.nodeName&&((null!=n.nodeValue&&n.nodeValue.trim().length>0)||(n.childNodes.length>0&&n.childNodes.item(0).nodeName=="#text"&&n.childNodes.item(0).nodeValue.trim().length>0)||(n.childNodes.length>1))){var value=(new XMLSerializer()).serializeToString(n);buffer+=value;}}}else if(3==n.nodeType){console.log("Removing nodeless text from content: "+n.nodeValue);}}
if(buffer.length>0){ds+="<div ";ds+="id='secure-content-"+c+"' ";ds+="class='secure-content role:"+self._permissions[0]+"'>";ds+=buffer;ds+="</div>";}
ds+="</body>";console.log("New body: "+ds);body=textToXML(ds);}
var divs=null;var content="<h2 class='markings-content-title'>Document Secure Content</h2>";self.body=body;if(undefined==body){content+="<p><b>Document has no content</b></p>";}else{content+="<table class='markings-content-table'>";divs=body.getElementsByTagName("div");for(var d=0;d<divs.length;d++){var div=divs[d];var classString=div.getAttribute("class");var classes=classString.split(" ");var readPerms=new Array();var redacted=false;for(var c=0;c<classes.length;c++){var cls=classes[c];var pos=cls.indexOf("role:");if(0==pos){var perm=cls.substring(5);readPerms.push(perm);console.log("read perm: '"+perm+"'");}
if("secure-redaction"==cls){redacted=true;}}
content+="<tr class='markings-content-row'>";content+="<td class='markings-content-section-";if(self.tripleEditor){content+="part";}else{content+="full";}
content+="'><div class='markings-content-section-content '>";if(redacted){}else{content+="<div class='markings-content-section-controls'>";content+="<label for='"+self.container+"-markings-section-content-"+d+"'>Role for Read access: </label>";content+="<select id='"+self.container+"-markings-section-content-id-"+d+"'>";for(var p=0;p<self._permissions.length;p++){content+="<option value='"+self._permissions[p];console.log("this perm: '"+self._permissions[p]+"'");if(readPerms[0]==self._permissions[p]){content+="' selected='selected";}
content+="'>"+self._permissions[p]+"</option>";}
content+="</select>";content+="</div>";}
content+="<div class='markings-content-section-html'>";var xmlContent=(new XMLSerializer()).serializeToString(div);var divJson={index:d,content:xmlContent,role:readPerms[0],redacted:redacted,triples:new Array(),htmlid:div.getAttribute("id")};content+=xmlContent;content+="</div>";content+="</div></td>";if(self.tripleEditor){content+="<td class='markings-content-section-triples'><h2 class='markings-triples-title'>Extracted Facts [<a href='#'>+</a>]</h2>";if(redacted){content+="<p>Triples not available</p>";}else{var objects=new Array();self._extractFacts(div,objects);content+="<div class='markings-content-section-triple-list'>";for(var t=0;t<objects.length;t++){for(var t2=0;t2<objects.length;t2++){for(var vt=0;vt<self.validTriples.length;vt++){if(t!=t2){if(self.validTriples[vt].subjectType==objects[t].type&&self.validTriples[vt].objectType==objects[t2].type){var tripId=self.container+"-markings-triple-"+self.nextTripleId++;self._tripleIDs.push(tripId);self._tripleSection[tripId]=d;content+="<div class='markings-triple' id='"+tripId+"'>";content+="[<a href='#'>-</a>] <span class='"+objects[t].type+"' id='"+tripId+"-subject'>"+objects[t].value+"</span>";content+="<select id='"+tripId+"-predicate'>";var rels=self.validTriples[vt].predicateArray;for(var r=0;r<rels.length;r++){content+="<option ";if(0==r){content+="selected='selected' ";}
content+="value='"+rels[r]+"'>"+rels[r]+"</option>";}
content+="</select>";content+="<span class='"+objects[t2].type+"' id='"+tripId+"-object'>"+objects[t2].value+"</span>";content+="</div>";}}}}}
content+="</div>";}
content+="</td>";}
self.sections.push(divJson);content+="</tr>";}
content+="</table>";}
content+="<div class='markings-actionbar'><form id='"+self.container+"-markings-docsubmit'><input type='submit' value='Publish Changes' />"+"<span id='"+self.container+"-done'></span></form></div>";document.getElementById(cid).innerHTML=content;if(undefined!=body){for(var d=0;d<divs.length;d++){console.log("Section div loop. d: "+d);var div=divs[d];var id=self.container+"-markings-section-content-id-"+d;var sel=document.getElementById(id);if(null!=sel){var index=self.sections[d].index;sel.onchange=function(evt){self._updateSectionRole(index,sel.value);}}}}
document.getElementById(self.container+"-markings-docsubmit").onsubmit=function(evt){try{self.__saveDocument();}catch(ex){console.log("EXCEPTION on save : "+ex.message);for(var prop in ex)
{console.log("property: "+prop+" value: ["+ex[prop]+"]\n");}}
return false;};});};com.marklogic.widgets.markings.prototype._extractFacts=function(el,objects){console.log("_extractFacts: "+el.nodeName);if(el.nodeName=="span"&&(el.getAttribute("class")=="placename"||el.getAttribute("class")=="organisation"||el.getAttribute("class")=="person")){console.log("got fact: "+el.getAttribute("class")+" = "+el.childNodes.item(0).childNodes.item(0).nodeValue);objects.push({type:el.getAttribute("class"),value:el.childNodes.item(0).childNodes.item(0).nodeValue});}else{if(el.childNodes!=undefined){for(var i=0;i<el.childNodes.length;i++){this._extractFacts(el.childNodes.item(i),objects);}}}};com.marklogic.widgets.markings.prototype._getSection=function(idx){for(var i=0;i<this.sections.length;i++){if(this.sections[i].index==idx){return this.sections[i];}}
return null;};com.marklogic.widgets.markings.prototype._updateSectionRole=function(idx,role){console.log("_updateSectionRole idx: "+idx+", role: "+role);this._getSection(idx).role=role;};com.marklogic.widgets.markings.prototype.__saveDocument=function(){console.log("__saveDocument");var nd="<html xmlns='http://www.w3.org/1999/xhtml'>";console.log("head content: "+this.head);nd+=this.head;nd+="<body xmlns='http://www.w3.org/1999/xhtml'>";for(var s=0;s<this.sections.length;s++){var section=this.sections[s];var sid=section.htmlid;console.log("SID: "+sid);var sc=document.getElementById(sid);nd+="<div class='secure-section role:"+section.role+"'>";for(var c=0;c<sc.childNodes.length;c++){var xml=sc.childNodes.item(c);console.log("serialising xml: "+xml);nd+=(new XMLSerializer()).serializeToString(xml);}
nd+="</div>";}
nd+="</body></html>";console.log("NEW document content: "+nd);var ndx=textToXML(nd);var self=this;mljs.defaultconnection.save(ndx,this.docuri,{contentType:"application/xml",format:"xml"},function(result){console.log("DOC SAVE RESULT: "+JSON.stringify(result));var completeFunc=function(result){mljs.defaultconnection.logger.debug("ADDED ALL TRIPLE GRAPHS! Result: "+JSON.stringify(result.doc));document.getElementById(self.container+"-done").innerHTML=com.marklogic.widgets.bits.done(self.container+"-done-msg");}
var graphsAdded=0;var divs=self.body.getElementsByTagName("div");var completeCheck=function(result){graphsAdded++;if(graphsAdded==divs.length){completeFunc(result);}}
for(var d=0;d<divs.length;d++){var div=divs[d];var triples="";var classes=new Array();for(var t=0;t<self._tripleIDs.length;t++){var tripId=self._tripleIDs[t];mljs.defaultconnection.logger.debug("Processing Triple ID: "+tripId);var section=self._tripleSection[tripId];if(d==section){var hp=document.getElementById(tripId);var sh=document.getElementById(tripId+"-subject");var ph=document.getElementById(tripId+"-predicate");var oh=document.getElementById(tripId+"-object");var stype=sh.getAttribute("class");var svalue=sh.childNodes.item(0).nodeValue;var pvalue=ph.value;var otype=oh.getAttribute("class");var ovalue=oh.childNodes.item(0).nodeValue;var gotSubject=false;var theSubject=null;for(var cl=0;!gotSubject&&cl<classes.length;cl++){gotSubject=classes[cl].type==stype&&classes[cl].value==svalue;if(gotSubject){theSubject=classes[cl];}}
var subjectIRI="";if(!gotSubject){subjectIRI=self._iriPatterns[stype].replace("#VALUE#",encodeURI(svalue));theSubject={type:stype,value:svalue,objectIRI:subjectIRI,typeIRI:self._rdfTypes[stype]};classes.push(theSubject);}
var theObject=null;var gotObject=false;for(var cl=0;!gotObject&&cl<classes.length;cl++){gotObject=classes[cl].type==otype&&classes[cl].value==ovalue;if(gotObject){theObject=classes[cl];}}
var objectIRI="";if(!gotObject){objectIRI=self._iriPatterns[otype].replace("#VALUE#",encodeURI(ovalue));theObject={type:otype,value:ovalue,objectIRI:objectIRI,typeIRI:self._rdfTypes[otype]};classes.push(theObject);}
triples+="<"+theSubject.objectIRI+"> <"+self._predicates[pvalue]+"> <"+theObject.objectIRI+"> .\n";}}
var graphURI=self._tripleCollections[0].replace("#SECTIONID#","secure-content-"+d).replace("#URI#",self.docuri);triples+="<"+graphURI+"> <http://marklogic.com/semantics/ontology/derived_from> <"+self.docuri+"> .";var classess="";for(var cl=0;cl<classes.length;cl++){classess+="<"+classes[cl].objectIRI+"> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <"+classes[cl].typeIRI+"> .\n";classess+="<"+classes[cl].objectIRI+"> <"+self._commonNamePredicates[classes[cl].type]+"> \""+classes[cl].value+"\"@en .\n";}
var graphData=classess+triples;mljs.defaultconnection.logger.debug("Setting graph URI: "+graphURI+" to data: "+graphData);if(graphData.trim().length>0){mljs.defaultconnection.saveGraph(graphData,graphURI,function(result){completeCheck(result);});}else{completeCheck({doc:{result:"blank doc success"}});}}});};